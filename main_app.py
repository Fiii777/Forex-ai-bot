import streamlit as st
import feedparser
import requests
import pandas as pd
from transformers import pipeline
from datetime import datetime, date

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞ UI Theme ---
st.set_page_config(page_title="Gold AI Expert Specialist", layout="wide", page_icon="üè¶")

# --- 2. ‡πÇ‡∏´‡∏•‡∏î AI Sentiment (DistilBERT) ---
@st.cache_resource
def load_sentiment_ai():
    # ‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à
    return pipeline("sentiment-analysis", model="distilbert-base-uncased-finetuned-sst-2-english")

analyzer = load_sentiment_ai()

# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error ‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≥‡∏£‡∏≠‡∏á) ---
def get_live_expert_news():
    results = []
    today_str = date.today().strftime('%Y-%m-%d')
    
    # ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Forex Factory (Calendar)
    try:
        ff_url = "https://cdn-nfs.forexfactory.net/ff_calendar_thisweek.json"
        # ‡πÄ‡∏û‡∏¥‡πà‡∏° timeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
        ff_res = requests.get(ff_url, timeout=5) 
        if ff_res.status_code == 200:
            for item in ff_res.json():
                # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πà‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ‡πÉ‡∏ô‡∏õ‡∏µ 2026
                if today_str in item['date']:
                    label = analyzer(item['title'])[0]
                    impact = item['impact'].lower()
                    v_score = "üî¥ HIGH" if impact == 'high' else "üü° MEDIUM" if impact == 'medium' else "‚ö™ LOW"
                    weight = 3 if impact == 'high' else 2 if impact == 'medium' else 1
                    
                    results.append({
                        "Time": item['date'].split('T')[1][:5], # ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤ HH:MM
                        "Currency": item['currency'],
                        "Headline": item['title'],
                        "Volatility": v_score,
                        "Sentiment": label['label'],
                        "Confidence": f"{label['score']:.2%}",
                        "Weight": weight,
                        "Source": "Forex Factory"
                    })
    except Exception:
        # ‡∏´‡∏≤‡∏Å Forex Factory ‡∏•‡πà‡∏° ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á Error ‡∏™‡∏µ‡πÅ‡∏î‡∏á ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏ó‡∏ô
        pass

    # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å Investing.com RSS ‡∏´‡∏≤‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
    try:
        feed = feedparser.parse("https://www.investing.com/rss/news_285.rss")
        for entry in feed.entries[:5]:
            label = analyzer(entry.title)[0]
            results.append({
                "Time": "LIVE",
                "Currency": "ALL",
                "Headline": entry.title,
                "Volatility": "üü° MEDIUM",
                "Sentiment": label['label'],
                "Confidence": f"{label['score']:.2%}",
                "Weight": 1,
                "Source": "Investing.com"
            })
    except:
        pass
    
    return results

# --- 4. ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Dashboard ---
st.title("üè¶ Gold AI Expert Specialist")
st.markdown(f"**Live Analysis: ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà** {datetime.now().strftime('%d %B 2026')}")

# ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
if st.button('üîÑ Sync & Expert Re-analyze'):
    st.cache_data.clear()

with st.spinner('AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥...'):
    news_data = get_live_expert_news()

if news_data:
    df = pd.DataFrame(news_data)
    
    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ ---
    st.header("‚ú® Today's Gold Strategy")
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° Sentiment ‡πÅ‡∏•‡∏∞ Weight)
    bull_power = sum(df[df['Sentiment'] == 'POSITIVE']['Weight'])
    bear_power = sum(df[df['Sentiment'] == 'NEGATIVE']['Weight'])
    
    c1, c2, c3 = st.columns(3)
    c1.metric("Bullish Power üí™", bull_power)
    c2.metric("Bearish Power üìâ", bear_power)
    
    with c3:
        if bull_power > bear_power:
            st.success("### AI BIAS: üöÄ BUY GOLD")
        elif bear_power > bull_power:
            st.error("### AI BIAS: üìâ SELL GOLD")
        else:
            st.warning("### AI BIAS: ‚öñÔ∏è NEUTRAL")

    st.divider()
    
    # --- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á ---
    st.subheader("üìë Live News Feed & Volatility Analysis")
    st.dataframe(df[['Time', 'Source', 'Headline', 'Volatility', 'Sentiment', 'Confidence']], use_container_width=True)
    
    # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏£‡∏á (High Impact)
    high_impact_list = df[df['Volatility'].str.contains("üî¥")]
    if not high_impact_list.empty:
        st.warning(f"üö® **‡∏£‡∏∞‡∏ß‡∏±‡∏á:** ‡∏û‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡∏∞‡∏î‡∏±‡∏ö High Impact {len(high_impact_list)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!")
else:
    # ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏≤‡∏Å‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
    st.error("‚ö†Ô∏è **Connection Error:** ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏î‡πÑ‡∏î‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (Network Timeout)")
    st.info("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Sync ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á")
    st.write("‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà")
